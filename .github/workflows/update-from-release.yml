name: Update from Main Repo

on:
  repository_dispatch:
    types: [new_release]

jobs:
  update-site:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Website
        uses: actions/checkout@v4

      - name: Fetch latest release and update data
        run: |
          RELEASE=$(curl -s https://api.github.com/repos/MickaelRiss/kyte/releases/latest)

          VERSION=$(echo "$RELEASE" | jq -r '.tag_name | ltrimstr("v")')
          MACOS_URL=$(echo "$RELEASE" | jq -r '.assets[] | select(.name | endswith(".dmg")) | .browser_download_url')
          WINDOWS_URL=$(echo "$RELEASE" | jq -r '.assets[] | select(.name | endswith(".exe")) | .browser_download_url')
          LINUX_URL=$(echo "$RELEASE" | jq -r '.assets[] | select(.name | endswith(".AppImage")) | .browser_download_url')

          jq -n \
            --arg version "$VERSION" \
            --arg macos "$MACOS_URL" \
            --arg windows "$WINDOWS_URL" \
            --arg linux "$LINUX_URL" \
            '{version: $version, assets: {macos: $macos, windows: $windows, linux: $linux}}' > data/release.json

          echo "Updated release.json to version $VERSION"
          cat data/release.json

      - name: Commit and Push
        run: |
          git config --global user.name "Mickael Riss"
          git config --global user.email "mendos.prod@gmail.com"
          git add data/release.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update release to v$(jq -r '.version' data/release.json)"
          git push
